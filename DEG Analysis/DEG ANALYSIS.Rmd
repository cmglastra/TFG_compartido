---
title: "DEG analysis with Limma Package and Representation in Volcano Plot"
output: html_document
date: "2022-12-16"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(BiocManager)
library(limma)
library(WGCNA)
library(base)
setwd("C:/Users/Usuario/Desktop/R/VOINEAGU_GSE28521")
load(file="Clean data (allData and datExpr1) 14Dic.RData") #created with the code in "data
#cleaning and normalization"
datExpr0=datExpr1 #renombramos como datExpr0 a la matriz con la que vamos a empezar a trabajar. Es la matriz de expresion con los datos NA eliminados, y los nombres de los genes en las filas (matriz limpiada en el cÛdigo de data cleaning + normalization)

```

1. Mean Expressions (not used)
```{r}
#A-CERE=(1:10) 1
#C-CERE=(11:21) 2
#A-CORTEX=(22:37,54:66)   3 
#C-CORTEX=(38:53,67:79)   4
library(dplyr)
col_A_CERE=c(1:10)
col_C_CERE=c(11:21)
col_A_CORTEX=c(22:37,54:66)
col_C_CORTEX=c(38:53,67:79)

expr_A_CERE=datExpr0%>%select(col_A_CERE)
expr_C_CERE=datExpr0%>%select(col_C_CERE)
expr_A_CORTEX=datExpr0%>%select(col_A_CORTEX)
expr_C_CORTEX=datExpr0%>%select(col_C_CORTEX)


mean_expr_A_CERE=mean(colMeans(expr_A_CERE))
mean_expr_C_CERE=mean(colMeans(expr_A_CERE))
mean_expr_A_CORTEX=mean(colMeans(expr_A_CORTEX))
mean_expr_C_CORTEX=mean(colMeans(expr_C_CORTEX))

mean_expr_all=as.matrix(t(c(mean_expr_A_CERE,
                          mean_expr_C_CERE,
                          mean_expr_A_CORTEX,
                          mean_expr_C_CORTEX)))

colnames(mean_expr_all)=c("A_CERE","C_CERE","A_CORTEX","C_CORTEX")
rownames(mean_expr_all)="MEAN EXPRESSION values for each condition, for ALL GENES"
```




2. DEG Analysis
```{r}
experimental.design0=model.matrix((~ 0+factor(c(1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,3,3,3,3,3,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4))))
colnames(experimental.design0)=c("A_CERE","C_CERE","A_CORTEX","C_CORTEX")

#medias de las r√©plicas 1, 2, 3, 4 (media de las replicas para cada condici√≥n)
linear.fit <- lmFit(datExpr0, experimental.design0)

#contrast matrix contiene comparaciones , que se calculan como diferencias porq los valores de expresion estan en log2 (expr1/expr2 = log(expr1)-log(expr2))
contrast.matrix0=makeContrasts(A_CERE-C_CERE,
                               A_CORTEX-C_CORTEX,
                               A_CORTEX-A_CERE,
                               C_CORTEX-C_CERE,
                               levels=c("A_CERE",
                                        "C_CERE",
                                        "A_CORTEX",
                                        "C_CORTEX"))

#ace un producto matricial y calcula el Fold Change
contrast.linear.fit <- contrasts.fit(linear.fit, contrast.matrix0)
#inferencia Bayesiana: hace una t-Student moderada con la funcion eBayes
contrast.results <- eBayes(contrast.linear.fit)



A_CEREvsC_CERE <- topTable(contrast.results, number=Inf,coef=1)
head(A_CEREvsC_CERE)


A_CORTEXvsC_CORTEX <- topTable(contrast.results, number=Inf,coef=2)#sort.by="logFC")
head(A_CORTEXvsC_CORTEX)


logFC_CERE= A_CEREvsC_CERE$logFC
logFC_CORTEX=A_CORTEXvsC_CORTEX$logFC

FDR_CERE=A_CEREvsC_CERE$adj.P.Val
log_FDR_CERE=-log10(FDR_CERE)
FDR_CORTEX=A_CORTEXvsC_CORTEX$adj.P.Val
log_FDR_CORTEX=-log10(FDR_CORTEX)


IDs_CERE=rownames(A_CEREvsC_CERE)
IDs_CORTEX=rownames(A_CORTEXvsC_CORTEX)

names(logFC_CERE)=IDs_CERE
names(FDR_CERE)=IDs_CERE
names(log_FDR_CERE)=IDs_CERE

names(logFC_CORTEX)=IDs_CORTEX
names(FDR_CORTEX)=IDs_CORTEX
names(log_FDR_CORTEX)=IDs_CORTEX

log10(2)
```


CREATE MATRICES WITH ACTIVATED/REPRESSED GENES AND COMBINE THEM INTO A DEGs MATRIX
```{r}

activated_CERE=A_CEREvsC_CERE[which(logFC_CERE>log10(1.3)&FDR_CERE<0.05),]
head(activated_CERE)
dim(activated_CERE)


activated_CORTEX=A_CORTEXvsC_CORTEX[which(logFC_CORTEX>0.1139434&FDR_CORTEX<0.05),]
head(activated_CORTEX)
dim(activated_CORTEX)


repressed_CERE=A_CEREvsC_CERE[which(logFC_CERE<(-log10(1.3))&FDR_CERE<0.05),]
head(repressed_CERE)
dim(repressed_CERE)


repressed_CORTEX=A_CORTEXvsC_CORTEX[which(logFC_CORTEX<(-0.1139434)&FDR_CORTEX<0.05),]
dim(repressed_CORTEX)
head(repressed_CORTEX)



IDs_activated_CERE=rownames(activated_CERE)
IDs_activated_CORTEX=rownames(activated_CORTEX)
IDs_repressed_CERE=rownames(repressed_CERE)
IDs_repressed_CORTEX=rownames(repressed_CORTEX)



DEGsMatrix=as.matrix(rbind(activated_CERE,activated_CORTEX,repressed_CERE,repressed_CORTEX))
head(DEGsMatrix)
dim(DEGsMatrix)

#comprobar que la matrix DEGs tiene el mismo numero de filas (genes) que cada una de las matrices que la componen por separado
nrow(activated_CERE)+nrow(activated_CORTEX)+nrow(repressed_CERE)+nrow(repressed_CORTEX)


datExprDEGs=subset(datExpr0,rownames(datExpr0)%in%rownames(DEGsMatrix))
head(datExprDEGs)

save(activated_CERE,activated_CORTEX,repressed_CERE,repressed_CORTEX, datExprDEGs, file="Activated and repressed genes in cerebellum and cortex and complete DEG matrix.RData")

#esta matriz contiene, para cada comparacion, y para cada gen, el FC y el q-valor (FDR). 


```


GRAPHIC REPRESENTATION OF DEGs - VOLCANO PLOTS

1st. add column of color identifier to the topTable matrices
```{r}

#aÒadir columna de color
A_CEREvsC_CERE$color=ifelse(
  A_CEREvsC_CERE$logFC>(log2(1.3))&
    A_CEREvsC_CERE$adj.P.Val<0.05,
  "red",
  ifelse(A_CEREvsC_CERE$logFC<(-log2(1.3))&A_CEREvsC_CERE$adj.P.Val<0.05,"blue", "grey"))


A_CORTEXvsC_CORTEX$color=ifelse(
  A_CORTEXvsC_CORTEX$logFC>(log2(1.3))&
    A_CORTEXvsC_CORTEX$adj.P.Val<0.05,
  "red",
  ifelse(A_CORTEXvsC_CORTEX$logFC<(-log2(1.3))&A_CORTEXvsC_CORTEX$adj.P.Val<0.05,"blue", "grey"))
```


CERE DEGs REPRESENTATION IN GGPLOT
```{r}
p_cere<-ggplot(A_CEREvsC_CERE,
       aes(x=logFC,
           y=(-log10(adj.P.Val)),
           color=color))+
  coord_cartesian(xlim=c(-2,2))+
  geom_point()+
  scale_x_continuous(name = "log2 fold change") +
  scale_y_continuous(name = "-log10 (FDR)")+
 
  scale_color_manual(values = c("red" = "red", "blue" = "blue", "grey"="grey"), labels=c("Overexpressed","Underexpressed","Non-DE"))+
  guides(color=guide_legend(title="Expression Satus"))+
  ggtitle("Volcano plot for DEG selection in CEREBELLUM (FC>+-1.3, FDR<0.05)") +
  geom_vline(xintercept=c(log2(1.3),-log2(1.3)),lty="dashed", color=c("red", "blue"))+
  geom_hline(yintercept=-log10(0.05),color="black",lty="dashed")
  theme(legend.key.width = unit(0.1,"cm"))
  
  
plot(p_cere)

```


CORTEX DEGS REPRESENTATION IN GGPLOT
```{r}
p_cortex<-ggplot(A_CORTEXvsC_CORTEX,
       aes(x=logFC,
           y=(-log10(adj.P.Val)),
           color=color))+
  coord_cartesian(xlim=c(-2,2))+
  geom_point()+
  scale_x_continuous(name = "log2 fold change") +
  scale_y_continuous(name = "-log10 (FDR)")+
 
  scale_color_manual(values = c("red" = "red", "blue" = "blue", "grey"="grey"), labels=c("Overexpressed","Underexpressed","Non-DE"))+
  guides(color=guide_legend(title="Expression Satus"))+
  ggtitle("Volcano plot for DEG selection in CORTEX (FC>+-1.3, FDR<0.05)") +
  geom_vline(xintercept=c(log2(1.3),-log2(1.3)),lty="dashed", color=c("red", "blue"))+
  geom_hline(yintercept=-log10(0.05),color="black",lty="dashed")
  theme(legend.key.width = unit(0.1,"cm"))

plot(p_cortex)
```


```{r}
#remember to make the window big before saving
ggsave("Volcano plot of DEG selection in CORTEX (FC+-1.3).png", plot=p_cortex, dpi=300)
ggsave("Volcano plot of DEG selection in CEREBELLUM (FC+-1.3).png", plot=p_cere, dpi=300)


```



FRONTAL vs. TEMPORAL CORTEX ANALYSIS



Add column to topTable matrices with a colour identifier
```{r}

#aÒadir columna de color
A_TEMPvsC_TEMP$color=ifelse(
  A_TEMPvsC_TEMP$logFC>(log2(1.3))&
    A_TEMPvsC_TEMP$adj.P.Val<0.05,
  "red",
  ifelse(A_TEMPvsC_TEMP$logFC<(-log2(1.3))&A_TEMPvsC_TEMP$adj.P.Val<0.05,"blue", "grey"))


A_FRONTvsC_FRONT$color=ifelse(
  A_FRONTvsC_FRONT$logFC>(log2(1.3))&
    A_FRONTvsC_FRONT$adj.P.Val<0.05,
  "red",
  ifelse(A_FRONTvsC_FRONT$logFC<(-log2(1.3))&A_FRONTvsC_FRONT$adj.P.Val<0.05,"blue", "grey"))

```


volcano plot of TEMP DEGs
```{r}
p_temp<-ggplot(A_TEMPvsC_TEMP,
       aes(x=logFC,
           y=(-log10(adj.P.Val)),
           color=color))+
  coord_cartesian(xlim=c(-2,2))+
  geom_point()+
  scale_x_continuous(name = "log2 fold change") +
  scale_y_continuous(name = "-log10 (FDR)")+
 
  scale_color_manual(values = c("red" = "red", "blue" = "blue", "grey"="grey"), labels=c("Overexpressed","Underexpressed","Non-DE"))+
  guides(color=guide_legend(title="Expression Satus"))+
  ggtitle("Volcano plot for DEG selection in TEMPORAL CORTEX (FC>+-1.3, FDR<0.05)") +
  geom_vline(xintercept=c(log2(1.3),-log2(1.3)),lty="dashed", color=c("red", "blue"))+
  geom_hline(yintercept=-log10(0.05),color="black",lty="dashed")
  theme(legend.key.width = unit(0.1,"cm"))


plot(p_temp)
```


volcano plot of FRONT DEGs
```{r}
p_front<-ggplot(A_FRONTvsC_FRONT,
       aes(x=logFC,
           y=(-log10(adj.P.Val)),
           color=color))+
  coord_cartesian(xlim=c(-2,2))+
  geom_point()+
  scale_x_continuous(name = "log2 fold change") +
  scale_y_continuous(name = "-log10 (FDR)")+
 
  scale_color_manual(values = c("red" = "red", "blue" = "blue", "grey"="grey"), labels=c("Overexpressed","Underexpressed","Non-DE"))+
  guides(color=guide_legend(title="Expression Satus"))+
  ggtitle("Volcano plot for DEG selection in FRONTAL CORTEX (FC>+-1.3, FDR<0.05)") +
  geom_vline(xintercept=c(log2(1.3),-log2(1.3)),lty="dashed", color=c("red", "blue"))+
  geom_hline(yintercept=-log10(0.05),color="black",lty="dashed")
  theme(legend.key.width = unit(0.1,"cm"))


plot(p_front)
```


save graphs
```{r}
#remember to make the window big before saving
ggsave("Volcano plot of DEG selection in TEMPORAL CORTEX (FC+-1.3).png", plot=p_temp, dpi=300)
ggsave("Volcano plot of DEG selection in FRONTAL CORTEX (FC+-1.3).png", plot=p_front, dpi=300)

```


